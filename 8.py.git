import sqlite3


# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
def get_connection():
    return sqlite3.connect("shop.db")


# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
def create_tables():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS customers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL
    )
    """)

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS orders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER,
        product TEXT,
        price REAL,
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    )
    """)

    conn.commit()
    conn.close()


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
def add_customer(name):
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("INSERT INTO customers (name) VALUES (?)", (name,))
    conn.commit()
    conn.close()


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
def add_order(customer_id, product, price):
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO orders (customer_id, product, price) VALUES (?, ?, ?)",
        (customer_id, product, price)
    )
    conn.commit()
    conn.close()


# JOIN –∑–∞–ø—Ä–æ—Å
def show_customers_orders():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("""
    SELECT customers.name, orders.product, orders.price
    FROM customers
    LEFT JOIN orders ON customers.id = orders.customer_id
    """)

    rows = cursor.fetchall()
    print("\nüìñ Customers and their orders:")
    for row in rows:
        print(row)

    conn.close()


# –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
def aggregate_functions():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT COUNT(*) FROM orders")
    print("\nTotal orders:", cursor.fetchone()[0])

    cursor.execute("SELECT MAX(price) FROM orders")
    print("Max price:", cursor.fetchone()[0])

    cursor.execute("SELECT AVG(price) FROM orders")
    print("Average price:", cursor.fetchone()[0])

    conn.close()


# GROUP BY
def orders_count_per_customer():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("""
    SELECT customers.name, COUNT(orders.id)
    FROM customers
    LEFT JOIN orders ON customers.id = orders.customer_id
    GROUP BY customers.name
    """)

    print("\nüìä Orders per customer:")
    for row in cursor.fetchall():
        print(row)

    conn.close()


# SUBQUERY
def customers_with_expensive_orders():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("""
    SELECT name FROM customers
    WHERE id IN (
        SELECT customer_id FROM orders WHERE price > 100
    )
    """)

    print("\nüëÄ Customers with expensive orders (>100):")
    for row in cursor.fetchall():
        print(row[0])

    conn.close()


# VIEW
def create_view():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("""
    CREATE VIEW IF NOT EXISTS customer_orders_view AS
    SELECT customers.name, orders.product, orders.price
    FROM customers
    JOIN orders ON customers.id = orders.customer_id
    """)

    conn.commit()
    conn.close()


def show_view():
    conn = get_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT * FROM customer_orders_view")
    print("\nüëÅ Data from VIEW:")
    for row in cursor.fetchall():
        print(row)

    conn.close()


# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
if __name__ == "__main__":
    create_tables()

    add_customer("Ali")
    add_customer("Amina")
    add_customer("Sanjar")

    add_order(1, "Laptop", 1200)
    add_order(1, "Mouse", 20)
    add_order(2, "Phone", 500)
    add_order(3, "Book", 15)

    show_customers_orders()
    aggregate_functions()
    orders_count_per_customer()
    customers_with_expensive_orders()

    create_view()
    show_view()
